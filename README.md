# ESP32-S3 语音助手项目

## 项目概述

本项目基于ESP32-S3微控制器，结合MAX98357AETE I2S音频放大器、INMP441数字麦克风和3W扬声器，实现一个完整的语音助手系统。该系统通过WiFi连接云端API，使用阿里云的语音处理模型，实现语音识别、智能对话和语音合成功能，并具备唤醒机制和睡眠监测功能。

## 硬件组成

- ESP32-S3 开发板
- MAX98357AETE I2S音频放大器
- INMP441 数字麦克风
- 3W 扬声器
- 面包板和连接线

## 硬件连接

### 硬件连接示意图

```
ESP32-S3          MAX98357A          INMP441          扬声器
+---------------+  +---------------+  +---------------+  +---------------+
|               |  |               |  |               |  |               |
|  GPIO12       |--|  BCLK         |  |  BCLK         |  |               |
|  (I2S_BCLK)   |  |               |  |               |  |               |
|               |  |               |  |               |  |               |
|  GPIO13       |--|  LRC          |  |  LRC          |  |               |
|  (I2S_LRC)    |  |               |  |               |  |               |
|               |  |               |  |               |  |               |
|  GPIO11       |--|  DIN          |  |               |  |               |
|  (I2S_DOUT)   |  |               |  |               |  |               |
|               |  |               |  |               |  |               |
|  GPIO10       |--|               |  |  DATA         |  |               |
|  (I2S_MIC_DIN)|  |               |  |               |  |               |
|               |  |               |  |               |  |               |
|  3.3V         |--|  VCC          |  |  VDD          |  |               |
|               |  |               |  |               |  |               |
|  GND          |--|  GND          |  |  GND          |  |               |
|               |  |               |  |               |  |               |
|               |  |  OUT+         |--|               |--|  正极         |
|               |  |               |  |               |  |               |
|               |  |  OUT-         |--|               |--|  负极         |
|               |  |               |  |               |  |               |
+---------------+  +---------------+  +---------------+  +---------------+
```

### 详细连接说明

#### ESP32-S3 与 MAX98357A 连接
- GPIO12 (I2S_BCLK) → MAX98357A BCLK
- GPIO13 (I2S_LRC) → MAX98357A LRC
- GPIO11 (I2S_DOUT) → MAX98357A DIN
- VCC → 3.3V
- GND → GND

#### ESP32-S3 与 INMP441 连接
- GPIO12 (I2S_BCLK) → INMP441 BCLK
- GPIO13 (I2S_LRC) → INMP441 LRC
- GPIO10 (I2S_DIN) → INMP441 DATA
- VCC → 3.3V
- GND → GND

#### MAX98357A 与扬声器连接
- MAX98357A OUT+ → 扬声器正极
- MAX98357A OUT- → 扬声器负极

## 软件功能

1. **WiFi连接管理**：自动连接指定WiFi网络，支持自动重连
2. **唤醒词检测**：支持自定义唤醒词，低功耗运行
3. **语音识别**：通过阿里云API实现高精度语音转文本
4. **智能对话**：通过阿里云API实现智能文本对话
5. **语音合成**：通过阿里云API实现自然的文本转语音
6. **睡眠监测**：无操作自动进入低功耗模式，节省电量

## 配置说明

### 1. 基本配置

修改 `config.h` 文件中的以下参数：

- WiFi名称和密码
- 阿里云API密钥和相关参数
- 硬件引脚配置（如需调整）
- 唤醒词阈值和睡眠超时设置

### 2. 阿里云API配置

#### 步骤1：注册阿里云账号

如果还没有阿里云账号，请先注册：[阿里云官网](https://www.aliyun.com/)

#### 步骤2：开通相关服务

在阿里云控制台开通以下服务：

1. **智能语音交互服务**
   - 用于语音转文本（ASR）和文本转语音（TTS）
   - 开通地址：[智能语音交互](https://ai.aliyun.com/nls)

2. **智能对话服务**
   - 用于文本对话功能
   - 开通地址：[智能对话](https://ai.aliyun.com/chatbot)

#### 步骤3：获取API密钥

1. 登录阿里云控制台
2. 进入「AccessKey管理」页面
3. 创建或获取现有的Access Key
4. 将Access Key和Access Secret填入 `config.h` 文件

### 3. 唤醒词模型配置

#### 步骤1：准备唤醒词模型

可以使用以下方法获取唤醒词模型：

1. 使用TensorFlow Lite for Microcontrollers训练自定义唤醒词模型
2. 使用开源的唤醒词模型，如Hey Snips或Porcupine
3. 对于简单应用，可以使用本项目提供的基础唤醒词检测算法

#### 步骤2：上传模型文件

将唤醒词模型文件上传到ESP32-S3的文件系统：

1. 使用ESP32 Sketch Data Upload工具
2. 或使用Arduino IDE的"Upload LittleFS data"功能
3. 模型文件应命名为 `wakeword_model.tflite` 并放在 `data` 目录中

## 使用方法

### 基本使用流程

1. **准备工作**
   - 按照硬件连接示意图连接所有硬件
   - 修改 `config.h` 文件中的WiFi信息和阿里云API配置
   - 上传唤醒词模型文件（如果使用自定义模型）

2. **上传代码**
   - 打开Arduino IDE
   - 选择正确的开发板（ESP32-S3 Dev Module）
   - 选择正确的端口
   - 上传 `voice_assistant.ino` 文件

3. **启动设备**
   - 给ESP32-S3上电
   - 观察串口监视器（波特率115200）
   - 等待WiFi连接成功

4. **使用语音助手**
   - 说出唤醒词（默认："你好，助手"）
   - 听到提示音后，说出您的问题或指令
   - 等待语音助手的回应

5. **睡眠模式**
   - 5分钟无操作后，设备会自动进入睡眠状态
   - 再次说出唤醒词可唤醒设备

### 测试模式

可以使用 `test_voice_assistant.ino` 文件进行功能测试：

1. 上传测试代码
2. 观察串口监视器中的测试结果
3. 按照测试提示进行操作

## 开发环境

### 软件要求

- Arduino IDE 1.8.10或更高版本
- ESP32 Board Support Package
- 所需库：
  - WiFi
  - HTTPClient
  - ArduinoJson
  - TensorFlow Lite for Microcontrollers（可选，用于唤醒词检测）

### 安装ESP32开发环境

1. 打开Arduino IDE
2. 进入「文件」→「首选项」
3. 在「附加开发板管理器网址」中添加：
   ```
   https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
   ```
4. 进入「工具」→「开发板」→「开发板管理器」
5. 搜索并安装「esp32」
6. 选择开发板：「ESP32 Arduino」→「ESP32-S3 Dev Module」

## 性能优化

### 电源优化

- 使用稳定的3.3V电源，确保电流足够（建议至少500mA）
- 考虑使用锂电池供电，增加移动性

### 网络优化

- 确保WiFi信号强度良好
- 考虑使用2.4GHz WiFi网络，覆盖范围更广
- 如网络不稳定，可以增加重试机制

### 音频优化

- 调整麦克风的位置，避免噪音干扰
- 确保扬声器与麦克风之间有适当的距离，避免回声
- 可以增加音频处理算法，如降噪和回声消除

## 故障排除

### 常见问题及解决方案

| 问题 | 可能原因 | 解决方案 |
|------|---------|--------|
| WiFi连接失败 | WiFi名称或密码错误 | 检查 `config.h` 中的WiFi配置 |
| | 网络信号弱 | 靠近路由器或使用信号放大器 |
| | ESP32-S3 WiFi模块故障 | 检查硬件连接或更换开发板 |
| 语音识别失败 | 网络连接不稳定 | 检查网络连接状态 |
| | 麦克风连接错误 | 检查麦克风接线 |
| | 阿里云API配置错误 | 检查API密钥和服务开通状态 |
| | 环境噪音过大 | 减少环境噪音或调整麦克风位置 |
| 无声音输出 | 扬声器连接错误 | 检查扬声器接线 |
| | 音频驱动配置错误 | 检查 `config.h` 中的音频配置 |
| | MAX98357A故障 | 检查音频放大器连接 |
| 唤醒词无响应 | 麦克风连接错误 | 检查麦克风接线 |
| | 唤醒词模型配置错误 | 检查唤醒词模型文件和配置 |
| | 环境噪音过大 | 减少环境噪音或调整麦克风位置 |
| 系统崩溃 | 内存不足 | 优化代码，减少内存使用 |
| | 网络请求超时 | 增加超时处理机制 |
| | 硬件故障 | 检查硬件连接和电源供应 |

### 调试技巧

1. **查看串口输出**
   - 打开Arduino IDE的串口监视器
   - 设置波特率为115200
   - 观察系统状态和错误信息

2. **使用调试模式**
   - 在 `debug_helpers.h` 中设置更高的调试级别
   - 重新上传代码
   - 观察详细的调试信息

3. **逐步测试**
   - 先测试硬件连接
   - 再测试WiFi连接
   - 最后测试API调用

4. **网络测试**
   - 使用手机热点测试网络连接
   - 检查路由器防火墙设置
   - 测试其他网络服务是否正常

## 扩展功能

### 可添加的功能

1. **多语言支持**：添加多语言语音识别和合成
2. **自定义指令**：添加特定领域的自定义指令
3. **家居控制**：集成智能家居控制功能
4. **天气查询**：添加天气查询功能
5. **定时器和闹钟**：添加定时器和闹钟功能
6. **音乐播放**：集成音乐播放功能
7. **远程控制**：添加手机APP远程控制功能
8. **多房间支持**：实现多房间语音助手协同工作

### 硬件扩展

1. **增加显示屏**：添加OLED或LCD显示屏，显示系统状态和信息
2. **增加按键**：添加物理按键，用于手动唤醒和控制
3. **增加传感器**：添加环境传感器，如温度、湿度、光线等
4. **增加电池管理**：添加锂电池和充电电路，实现便携使用
5. **增加存储**：添加SD卡，用于存储更多音频数据和模型


- [ESP32 Arduino Core](https://github.com/espressif/arduino-esp32)
- [ArduinoJson](https://arduinojson.org/)
- [TensorFlow Lite for Microcontrollers](https://www.tensorflow.org/lite/microcontrollers)
- [阿里云智能语音交互](https://ai.aliyun.com/nls)
- [阿里云智能对话](https://ai.aliyun.com/chatbot)

